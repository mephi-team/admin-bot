# Admin Bot Application

Административный интерфейс для управления чат-ботом Учебного Центра.  
Позволяет администраторам и экспертам работать с пользователями, диалогами, вопросами, рассылками, зачислением и аналитикой.

## Стек технологий

- **Backend**: Spring Boot 3.5.9, Java 21
- **Frontend**: Vaadin 24.9.9 (Java-based UI)
- **База данных**: PostgreSQL 18
- **Авторизация**: Keycloak (OIDC/OAuth2)
- **Интеграции**: NeoStudy API, Telegram Bot (через базу), SMTP
- **Сборка и контейнеризация**: Maven, Docker, Jib (через jlink)

## Быстрый старт

### 1. Запуск локально через Docker Compose

Проект поставляется с готовым `docker-compose.yml`, который поднимает все необходимые сервисы:

- `admin-bot` — основное приложение на Spring Boot + Vaadin
- `postgres` — база данных
- `keycloak` — сервер авторизации

```bash
# Сборка и запуск всех сервисов
docker compose up --build -d

# Приложение будет доступно по адресу:
# http://localhost:8080
```

**Учётные данные по умолчанию**:

- **Keycloak админка**: `http://localhost:8081`
    - Логин: `admin`
    - Пароль: `admin`
- **Тестовые пользователи** (см. `keycloak/realm-export.json`):
    - Админ: `admin1 / admin123`
    - Эксперт: `expert1 / password123`
    - Эксперт: `expert2 / password123`

### 2. Отключение HTTPS в Keycloak для Realm master

По умолчанию Keycloak требует HTTPS. Для локальной разработки его нужно отключить:

```bash
# Найти ID контейнера Keycloak
docker ps

# Зайти в контейнер
docker exec -it {containerID} bash

# Выполнить команды внутри контейнера
cd /opt/keycloak/bin
./kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin
./kcadm.sh update realms/master -s sslRequired=NONE
```

## Функциональность

Интерфейс реализует все требования из ТЗ:

- **Главная страница**: виджеты с непрочитанными вопросами, активными рассылками и задачами.
- **Пользователи**: просмотр, фильтрация, изменение ролей (`visitor`, `candidate`, `student` и др.), массовое добавление через Excel.
- **Вопросы**: раздел для экспертов (`lc_expert`) и админов. Поддержка ответов, переназначения направлений.
- **Диалоги**: история сообщений с пользователями, отправка сообщений от имени бота.
- **Рассылки**: создание, планирование, шаблоны, выбор получателей по сложным фильтрам, импорт из Excel.
- **Зачисление**:
    - **Вне потока**: генерация и отправка уникальных ссылок.
    - **Скрипт регистрации**: массовая загрузка пользователей из Excel с автоматической регистрацией в Keycloak и NeoStudy.
- **Аналитика**: UTM-отчёты, статистика по городам и направлениям, экспорт в Excel.

## Архитектура и интеграции

- **Монолит**: единое Spring Boot приложение.
- **База данных**: одна схема PostgreSQL со всеми таблицами (`users`, `dialogs`, `mailings`, `utm_reports` и т.д.).
- **Авторизация**: OAuth2 через Keycloak. Роли (`admin`, `lc_expert`) маппятся из realm-ролей Keycloak.
- **NeoStudy**: асинхронная интеграция через WebClient с retry-логикой.
- **Frontend**: полностью на Vaadin, без отдельного JavaScript-кода.

## Разработка

### Локальная сборка

```bash
# Сборка production-версии (с минифицированным frontend)
./mvnw clean package -Pproduction -DskipTests

# Запуск в режиме разработки
./mvnw spring-boot:run
```

### Профили Spring

- `dev` (по умолчанию): подключение к локальной БД, `ddl-auto=create-drop`.
- `prod`: используется в Docker-образе, подключение к `postgres` контейнеру.

### Тестирование

Проект содержит:
- **Unit-тесты** для моделей и сервисов.
- **Интеграционные тесты** с Testcontainers (PostgreSQL).
- Покрытие проверяется через JaCoCo.